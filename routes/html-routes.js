var path = require("path");

var isAuthenticated = require("../config/middleware/isAuthenticated");

module.exports = function(app, db) {
    app.get("/", function(req, res) {
        if(req.user) {
            res.redirect('/profiles')
        }else {
       res.sendFile(path.join(__dirname, "../views/index.html"));
        }
    });

    app.get("/signup", function(req, res) {
        if(req.user) {
            res.redirect('/profiles');
        }else {
        res.sendFile(path.join(__dirname, "../views/userCreate.html"));
        }
    });

    app.get("/profiles", isAuthenticated, function (req, res) {
        res.sendFile(path.join(__dirname, "../views/profiles.html"));
    });

    app.get("/login", function(req, res) {
        res.sendFile(path.join(__dirname, "../views/login.html"));
        
    });

    var name, image, ingredients, instructions, ingredientList;
    app.get("/search", function(req, res) {
        search("search.php?s=margarita"); // should be #drinksearch
        var obj = {
            ...name,
            ...image,
            ...ingredients,
            ...instructions
        }  
        res.redirect("index", obj)
    });
    
    app.get("/random", function(req, res){
        search("random.php");
        var obj = {
            ...name,
            ...image,
            ...ingredients,
            ...instructions
        }
        res.render("index", obj)
    });

    app.get("/random/favorite", function(req, res){
        var unirest = require("unirest");
        var req = unirest("GET", "https://www.thecocktaildb.com/api/json/v1/1/" + param);
        req.query({
            "a": "list"
        });
        req.headers({
            "x-rapidapi-host": "the-cocktail-db.p.rapidapi.com",
            "x-rapidapi-key": "1bb40a3f2cmsh737e756f49ff562p1d4980jsn6537251a9bc1"
        });
        req.end(function (res) {
            if (res.error) throw new Error(res.error);
            var cocktails = res.body.drinks[0];
            console.log(cocktails);
        });
        res.redirect("/random");
    });

    // app.get("*", function(req, res) {
    //     res.redirect("404");
    // });

    function search(param) {
        var unirest = require("unirest");
        var req = unirest("GET", "https://www.thecocktaildb.com/api/json/v1/1/" + param);
        req.query({
            "a": "list"
        });
        req.headers({
            "x-rapidapi-host": "the-cocktail-db.p.rapidapi.com",
            "x-rapidapi-key": "1bb40a3f2cmsh737e756f49ff562p1d4980jsn6537251a9bc1"
        });
        req.end(function (res) {
            if (res.error) throw new Error(res.error);
            var cocktails = res.body.drinks[0];
            console.log(cocktails);
            name = {
                drink_name: cocktails.strDrink
            }
            image = {
                drink_image: cocktails.strDrinkThumb
            }
            instructions = {
                drink_instructions: cocktails.strInstructions
            }
            ings = [];
            meas = [];
            ings.push(cocktails.strIngredient1, cocktails.strIngredient2, cocktails.strIngredient3, cocktails.strIngredient4,
                cocktails.strIngredient5, cocktails.strIngredient6, cocktails.strIngredient7, cocktails.strIngredient8,
                cocktails.strIngredient9, cocktails.strIngredient10, cocktails.strIngredient11, cocktails.strIngredient12,
                cocktails.strIngredient13, cocktails.strIngredient14, cocktails.strIngredient15
            )
            meas.push(cocktails.strMeasure1, cocktails.strMeasure2, cocktails.strMeasure3, cocktails.strMeasure4,
                cocktails.strMeasure5, cocktails.strMeasure6, cocktails.strMeasure7, cocktails.strMeasure8,
                cocktails.strMeasure9, cocktails.strMeasure10, cocktails.strMeasure11, cocktails.strMeasure12,
                cocktails.strMeasure13, cocktails.strMeasure14, cocktails.strMeasure15
            )
            ingredientList = ings.map(function (ing, index) {
                if (ing) return {
                    ingredient: ing,
                    measurement: meas[index],
                }
                else return false
            }).filter(function (ing) {
                return ing
            })
            ingredients = {
                drink_ingredients: ingredientList
            }
        });
    }

    // app.get("/api/signup", function(req, res) {
    //     res.redirect("userCreate");
    // });

    // app.get("/login", function(req, res) {
    //     if(req.user) {
    //         res.redirect("/profiles")
    //     }
    // });

    // app.get("/profiles", isAuthenticated, function(req, res) {
    //     res.redirect("/profiles");
    // });
};